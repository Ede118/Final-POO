<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inicio de sesi√≥n ‚Äî Robot RRR</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root {
      --bg:#e8f6ff;
      --card:#ffffff;
      --muted:#5d6b7a;
      --text:#0b2638;
      --accent:#0a6dd8;
      --accent-2:#095bb9;
      --error:#b00020;
      --line:#d0e6f7;
      --success:#2e7d32;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      display: grid;
      place-items: center;
      background: var(--bg);
      color: var(--text);
    }
    .card {
      width: min(420px, 92vw);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .title { font-size: 1.35rem; font-weight: 700; margin: 0 0 4px; }
    .sub { margin: 0 0 20px; color: var(--muted); font-size: .95rem; }
    form { display: grid; gap: 14px; }
    label { font-size: .9rem; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="text"], input[type="password"] {
      width: 100%; padding: 12px 14px; border-radius: 12px;
      border: 1px solid var(--line); background: #fff; color: var(--text);
    }
    input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent), transparent 85%); }
    .btn {
      width: 100%; padding: 12px 16px; border-radius: 12px; border: none;
      background: linear-gradient(180deg, var(--accent), var(--accent-2)); color: white; font-weight: 700; cursor: pointer;
    }
    .server-info {
      background: var(--accent-weak, #e6f2ff);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      text-align: center;
    }
    .server-ip {
      font-family: monospace;
      font-weight: bold;
      color: var(--accent);
      font-size: 1.1rem;
    }
    .success { color: var(--success); }
    .error { color: var(--error); }
    .token { 
      background: #e8f5e9; 
      border: 1px solid #c8e6c9; 
      border-radius: 6px; 
      padding: 8px; 
      margin: 10px 0;
      font-family: monospace;
      font-size: 1.1rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="logo" style="text-align:center; margin-bottom:20px;">
      <h1>Robot RRR</h1>
      <span style="color:var(--muted); font-size:.9rem;">Panel de Control</span>
    </div>

    <div class="server-info">
      <div style="font-size:.8rem; color:var(--muted);">Conectando a servidor:</div>
      <div class="server-ip" id="serverIpDisplay">Cargando...</div>
    </div>

    <h1 class="title">Iniciar sesi√≥n</h1>
    <p class="sub">Ingres√° usuario y contrase√±a</p>

    <form id="loginForm">
      <input type="hidden" id="serverIp" value="localhost">

      <label for="nick">Usuario</label>
      <input id="nick" type="text" placeholder="ADMIN, USER o VIEWER" required minlength="3" value="ADMIN">

      <label for="password">Contrase√±a</label>
      <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="1" value="ADMIN">

      <button class="btn" type="submit">Entrar</button>
      
      <div id="tokenDisplay" style="display: none;">
        <div class="token">Token: <span id="tokenValue"></span></div>
      </div>
      
      <p id="msg" class="legal" role="status" aria-live="polite"></p>
    </form>
  </main>

  <script src="/server_watch.js"></script>
  <script>
  // Obtener la IP del servidor de la URL actual - VERSI√ìN MEJORADA
  function getServerIP() {
    const hostname = window.location.hostname;
    console.log("üåê Hostname detectado:", hostname);
    
    // Si estamos en localhost o IP local, usar localhost
    if (hostname === 'localhost' || hostname === '127.0.0.1' || hostname === '') {
      return 'localhost';
    }
    // Si no, usar la IP del host actual
    return hostname;
  }

  // Configurar la IP autom√°ticamente
  function setupServerIP() {
    const serverIp = getServerIP();
    console.log("üîß Configurando IP del servidor:", serverIp);
    
    document.getElementById('serverIp').value = serverIp;
    document.getElementById('serverIpDisplay').textContent = serverIp + ':8080';
  }

  async function rpcCall(serverIp, method, paramsXml="") {
    const xml = `<?xml version="1.0"?>
<methodCall>
  <methodName>${method}</methodName>
  <params>${paramsXml}</params>
</methodCall>`;

    try {
      console.log("üì§ Enviando RPC a:", `http://${serverIp}:8080`);
      
      const res = await fetch(`http://${serverIp}:8080`, {
        method: "POST",
        headers: { "Content-Type": "text/xml" },
        body: xml
      });
      
      if (!res.ok) {
        throw new Error(`Error HTTP ${res.status}: ${res.statusText}`);
      }
      
      return await res.text();
    } catch (error) {
      console.error("‚ùå Error en RPC:", error);
      throw new Error(`No se pudo conectar al servidor ${serverIp}:8080. Verifica que el servidor est√© ejecut√°ndose.`);
    }
  }

  // Funci√≥n para parsear la respuesta XML
  function parseXmlResponse(xmlText) {
    console.log("üì• Respuesta XML recibida:", xmlText);
    
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
    
    // Verificar si es una respuesta de error (fault)
    const fault = xmlDoc.getElementsByTagName("fault")[0];
    if (fault) {
      const faultString = xmlDoc.getElementsByTagName("string")[1];
      return { success: false, error: faultString ? faultString.textContent : "Error desconocido" };
    }
    
    // Parsear respuesta exitosa
    const members = xmlDoc.getElementsByTagName("member");
    const result = { success: true };
    
    for (let member of members) {
      const name = member.getElementsByTagName("name")[0]?.textContent;
      const value = member.getElementsByTagName("string")[0]?.textContent;
      if (name && value) {
        result[name] = value;
      }
    }
    
    console.log("üìä Resultado parseado:", result);
    return result;
  }

  document.getElementById("loginForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const ip = document.getElementById("serverIp").value.trim();
    const nick = document.getElementById("nick").value.trim();
    const pass = document.getElementById("password").value.trim();
    const msg = document.getElementById("msg");
    const tokenDisplay = document.getElementById("tokenDisplay");
    
    msg.textContent = "Conectando con el servidor...";
    msg.className = "legal";
    tokenDisplay.style.display = "none";

    try {
      console.log("üîê Intentando login:", { ip, nick, pass });
      
      const xmlParams = `<param><value><string>${nick}</string></value></param>
                         <param><value><string>${pass}</string></value></param>`;
      
      const respuestaXml = await rpcCall(ip, "login", xmlParams);
      const resultado = parseXmlResponse(respuestaXml);
      
      // VERIFICACI√ìN M√ÅS ESTRICTA - Solo √©xito si status es "success"
      if (resultado.success && resultado.status === "success") {
        msg.textContent = `‚úÖ ${resultado.message || 'Login exitoso!'}`;
        msg.className = "legal success";
        
        // Mostrar token
        if (resultado.token) {
          document.getElementById("tokenValue").textContent = resultado.token;
          tokenDisplay.style.display = "block";
        }
        
        // Guardar en sessionStorage
        sessionStorage.setItem("server_ip", ip);
        sessionStorage.setItem("auth_token", resultado.token || "0000");
        sessionStorage.setItem("user_privilege", resultado.privilege || "viewer");
        sessionStorage.setItem("username", nick);
        
        // Redirigir seg√∫n privilegio despu√©s de 2 segundos
      setTimeout(() => {
        if (resultado.privilege === "admin") {
          window.location.href = "./admin_panel.html";
        } else if (resultado.privilege === "user") {
          window.location.href = "./user_panel.html";
        } else {
          window.location.href = "./viewer_panel.html";  // NUEVO: viewer va aqu√≠
        }
      }, 2000);
        
      } else {
        const errorMsg = resultado.error || "Credenciales inv√°lidas";
        msg.textContent = `‚ùå ${errorMsg}`;
        msg.className = "legal error";
        console.log("‚ùå Login fallido:", errorMsg);
      }
      
    } catch(err) {
      console.error("Error:", err);
      msg.textContent = `‚ùå ${err.message}`;
      msg.className = "legal error";
    }
  });

  // Configurar autom√°ticamente al cargar la p√°gina
  window.addEventListener('load', () => {
    setupServerIP();
    console.log("Usuarios demo disponibles:");
    console.log("- ADMIN / ADMIN (admin)");
    console.log("- USER / USER (user)"); 
    console.log("- VIEWER / VIEWER (viewer)");
  });
  </script>
</body>
</html>
