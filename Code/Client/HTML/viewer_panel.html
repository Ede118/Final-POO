<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Viewer ‚Äî Robot RRR</title>
  <style>
    :root{
      --bg:#e8f6ff; --card:#ffffff; --line:#d0e6f7;
      --text:#0b2638; --muted:#5d6b7a;
      --primary:#0a6dd8; --primary-weak:#e6f2ff;
      --danger:#b00020; --success:#2e7d32;
      --warning:#f57c00;
    }
    html,body{height:100%;}
    body{
      margin:0; font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--text);
    }
    .container{max-width:1200px; margin:24px auto; padding:0 16px;}
    h1{font-size:22px; margin:0 0 16px;}
    .grid{display:grid; gap:16px;}
    .g-2{grid-template-columns: 1fr 1fr;}
    .card{
      background:var(--card); border:1px solid var(--line); border-radius:12px;
      padding:16px; box-shadow:0 1px 0 rgba(10,20,30,0.04);
    }
    .compact-card {
      padding: 12px;
      max-width: 300px;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .btn{
      border:1px solid var(--primary); background:var(--primary-weak);
      color:var(--primary); padding:8px 12px;
      border-radius:8px; font-weight:600; cursor:pointer;
      transition: all 0.2s ease;
    }
    .btn:hover{background:var(--primary); color:white;}
    .btn-success{border-color:var(--success); color:#fff; background:var(--success);}
    .btn-success:hover{background:#1b5e20;}
    .muted{color:var(--muted); font-size:12px;}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px;
      background:#eef6ff; border:1px solid var(--line); font-size:12px;}
    .badge.on{background:#e8f5e9; border-color:#c8e6c9; color:var(--success);}
    .badge.off{background:#ffebee; border-color:#ffcdd2; color:var(--danger);}
    .spacer{height:8px}
    .footer{margin-top:16px; font-size:12px; color:var(--muted);}
    .section-title {font-size: 14px; font-weight: 600; margin: 0 0 8px 0; color: var(--text);}
    .info-row {display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;}
    .info-label {font-size: 11px; color: var(--muted);}
    .info-value {font-size: 11px; font-weight: 600;}
    .compact-grid {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
      align-items: start;
    }
    
    /* Estilos espec√≠ficos para video */
    .video-container {
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      min-height: 400px;
    }
    #cameraFeed {
      width: 100%;
      height: auto;
      display: block;
    }
    .video-placeholder {
      width: 100%;
      height: 400px;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.1rem;
      flex-direction: column;
      gap: 12px;
    }
    .camera-url {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--line);
      border-radius: 6px;
      margin-bottom: 12px;
      font-family: ui-monospace, Consolas, monospace;
      font-size: 12px;
    }
    .status {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      margin-top: 8px;
    }
    .status.connected {
      background: #e8f5e9;
      color: var(--success);
      border: 1px solid #c8e6c9;
    }
    .status.disconnected {
      background: #ffebee;
      color: var(--danger);
      border: 1px solid #ffcdd2;
    }
    .instructions {
      font-size: 12px;
      line-height: 1.4;
    }
    .instructions ul {
      margin: 8px 0;
      padding-left: 16px;
    }
    .instructions li {
      margin-bottom: 4px;
    }
    .instructions code {
      background: var(--primary-weak);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: ui-monospace, Consolas, monospace;
      font-size: 11px;
      color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Panel Viewer ‚Äî Robot RRR</h1>

    <div class="compact-grid">
      <section class="card compact-card">
        <div class="section-title">Informaci√≥n de Sesi√≥n</div>
        <div class="info-row">
          <span class="info-label">Usuario:</span>
          <span class="info-value" id="usernamePreview">‚Äî</span>
        </div>
        <div class="info-row">
          <span class="info-label">Privilegio:</span>
          <span class="info-value" id="privilegePreview">‚Äî</span>
        </div>
        <div class="info-row">
          <span class="info-label">Servidor:</span>
          <span class="info-value" id="ipPreview">‚Äî</span>
        </div>
        <div class="info-row">
          <span class="info-label">C√°mara:</span>
          <span class="info-value" id="cameraStatusPreview">Desconectada</span>
        </div>
      </section>

      <section class="card">
        <div class="section-title">Control de C√°mara</div>
        
        <div style="margin-bottom: 12px;">
          <div class="info-label">URL de la C√°mara:</div>
          <input type="text" id="cameraUrl" class="camera-url" 
                 placeholder="Ej: http://192.168.1.100:8080/video" 
                 value="http://192.168.1.100:8080/video">
        </div>
        
        <div class="row">
          <button class="btn btn-success" onclick="connectCamera()">‚ñ∂Ô∏è Conectar C√°mara</button>
          <button class="btn" onclick="disconnectCamera()">‚èπÔ∏è Desconectar</button>
          <button class="btn" onclick="takeSnapshot()">üì∏ Capturar Foto</button>
        </div>
        
        <div class="status disconnected" id="connectionStatus">
          üî¥ C√°mara desconectada
        </div>
      </section>
    </div>

    <div class="grid g-2" style="margin-top:16px;">
      <section class="card">
        <div class="section-title">Video en Tiempo Real</div>
        <div class="video-container">
          <img id="cameraFeed" src="" alt="Video en tiempo real">
          <div id="videoPlaceholder" class="video-placeholder">
            <div>üìπ Conecta tu c√°mara</div>
            <small class="muted">Usa el panel de control para conectar</small>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="section-title">Instrucciones de Conexi√≥n</div>
        <div class="instructions">
          <p><strong>Para conectar tu c√°mara:</strong></p>
          <ul>
            <li><strong>C√°mara IP:</strong> Usa la IP de tu c√°mara network</li>
            <li><strong>Tel√©fono Android:</strong> App "IP Webcam"</li>
            <li><strong>iPhone:</strong> App "IP Camera"</li>
          </ul>
          
          <p><strong>Ejemplos de URL:</strong></p>
          <ul>
            <li><code>http://192.168.1.100:8080/video</code></li>
            <li><code>http://192.168.1.100:8080/mjpeg</code></li>
            <li><code>http://192.168.1.100:4747/video</code></li>
          </ul>
          
          <p><strong>Nota:</strong> Aseg√∫rate de que tu c√°mara y este dispositivo est√©n en la misma red WiFi.</p>
        </div>
        
        <div class="spacer"></div>
        
        <div class="section-title">Acciones R√°pidas</div>
        <div class="row">
          <button class="btn" onclick="showSystemInfo()">‚ÑπÔ∏è Info Sistema</button>
          <button class="btn" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
        </div>
      </section>
    </div>

    <div class="footer">Panel de Viewer - Solo Visualizaci√≥n - Robot RRR</div>
  </div>

  <script>
    let cameraInterval = null;
    let isCameraConnected = false;

    // Elementos DOM
    const elements = {
      usernamePreview: document.getElementById('usernamePreview'),
      privilegePreview: document.getElementById('privilegePreview'),
      ipPreview: document.getElementById('ipPreview'),
      cameraStatusPreview: document.getElementById('cameraStatusPreview'),
      connectionStatus: document.getElementById('connectionStatus'),
      cameraFeed: document.getElementById('cameraFeed'),
      videoPlaceholder: document.getElementById('videoPlaceholder'),
      cameraUrl: document.getElementById('cameraUrl')
    };

    function initializePanel() {
      // Obtener la IP autom√°ticamente de la URL
      function getServerIP() {
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
          return 'localhost';
        }
        return window.location.hostname;
      }

      const serverIp = getServerIP();
      const username = sessionStorage.getItem('username');
      const privilege = sessionStorage.getItem('user_privilege');

      elements.ipPreview.textContent = serverIp;
      elements.usernamePreview.textContent = username || '‚Äî';
      elements.privilegePreview.textContent = privilege || '‚Äî';

      // Cargar URL guardada si existe
      const savedUrl = sessionStorage.getItem('camera_url');
      if (savedUrl) {
        elements.cameraUrl.value = savedUrl;
      }

      console.log('üöÄ Panel Viewer inicializado');
    }

    function connectCamera() {
      const url = elements.cameraUrl.value.trim();
      if (!url) {
        alert('Por favor ingresa la URL de la c√°mara');
        return;
      }

      // Limpiar conexi√≥n anterior
      disconnectCamera();

      const status = elements.connectionStatus;

      // Mostrar loading
      status.textContent = 'üü° Conectando...';
      status.className = 'status disconnected';

      // Configurar eventos de la imagen
      elements.cameraFeed.onload = function() {
        elements.videoPlaceholder.style.display = 'none';
        elements.cameraFeed.style.display = 'block';
        status.textContent = '‚úÖ C√°mara conectada';
        status.className = 'status connected';
        elements.cameraStatusPreview.textContent = 'Conectada';
        isCameraConnected = true;
        
        // Actualizar frame para video en tiempo real
        cameraInterval = setInterval(() => {
          elements.cameraFeed.src = url + '?t=' + new Date().getTime();
        }, 100);
      };

      elements.cameraFeed.onerror = function() {
        status.textContent = '‚ùå Error conectando a la c√°mara';
        status.className = 'status disconnected';
        elements.cameraFeed.style.display = 'none';
        elements.videoPlaceholder.style.display = 'flex';
        elements.videoPlaceholder.innerHTML = `
          <div>‚ùå Error de conexi√≥n</div>
          <small class="muted">Verifica la URL y conexi√≥n</small>
        `;
        elements.cameraStatusPreview.textContent = 'Error';
        isCameraConnected = false;
      };

      // Intentar cargar la imagen
      elements.cameraFeed.src = url;
      
      // Guardar URL en sessionStorage
      sessionStorage.setItem('camera_url', url);
    }

    function disconnectCamera() {
      if (cameraInterval) {
        clearInterval(cameraInterval);
        cameraInterval = null;
      }
      
      elements.cameraFeed.src = '';
      elements.cameraFeed.style.display = 'none';
      elements.videoPlaceholder.style.display = 'flex';
      elements.videoPlaceholder.innerHTML = `
        <div>üìπ Conecta tu c√°mara</div>
        <small class="muted">Usa el panel de control para conectar</small>
      `;
      elements.connectionStatus.textContent = 'üî¥ C√°mara desconectada';
      elements.connectionStatus.className = 'status disconnected';
      elements.cameraStatusPreview.textContent = 'Desconectada';
      isCameraConnected = false;
    }

    function takeSnapshot() {
      if (!isCameraConnected) {
        alert('Primero conecta una c√°mara');
        return;
      }

      // Crear un canvas para capturar la imagen
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = elements.cameraFeed.videoWidth || elements.cameraFeed.naturalWidth;
      canvas.height = elements.cameraFeed.videoHeight || elements.cameraFeed.naturalHeight;
      
      ctx.drawImage(elements.cameraFeed, 0, 0);
      
      // Crear enlace de descarga
      const link = document.createElement('a');
      link.download = `snapshot-${new Date().toISOString().replace(/[:.]/g, '-')}.png`;
      link.href = canvas.toDataURL();
      link.click();
      
      alert('üì∏ Foto capturada y descargada');
    }

    function showSystemInfo() {
      const info = `
üëÅÔ∏è Robot RRR - Informaci√≥n del Viewer
-----------------------------------
Usuario: ${sessionStorage.getItem('username') || 'No identificado'}
Privilegio: ${sessionStorage.getItem('user_privilege') || 'No definido'}
Servidor: ${sessionStorage.getItem('server_ip') || 'No configurado'}
C√°mara: ${isCameraConnected ? 'CONECTADA' : 'DESCONECTADA'}
URL: ${elements.cameraUrl.value || 'No configurada'}
      `.trim();
      
      alert(info);
    }

    function logout() {
      // Limpiar antes de salir
      disconnectCamera();
      sessionStorage.clear();
      window.location.href = 'signin.html';
    }

    // Guardar URL cuando cambie
    elements.cameraUrl.addEventListener('change', function() {
      sessionStorage.setItem('camera_url', this.value);
    });

    // Inicializar panel cuando carga la p√°gina
    window.addEventListener('load', initializePanel);

    // Conectar autom√°ticamente si hay URL guardada
    window.addEventListener('load', () => {
      setTimeout(() => {
        if (elements.cameraUrl.value) {
          connectCamera();
        }
      }, 1000);
    });
  </script>
</body>
</html>