<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inicio de sesión — Robot RRR</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root {
      --bg:#e8f6ff;
      --card:#ffffff;
      --muted:#5d6b7a;
      --text:#0b2638;
      --accent:#0a6dd8;
      --accent-2:#095bb9;
      --error:#b00020;
      --line:#d0e6f7;
      --success:#2e7d32;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      display: grid;
      place-items: center;
      background: var(--bg);
      color: var(--text);
    }
    .card {
      width: min(420px, 92vw);
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }
    .title { font-size: 1.35rem; font-weight: 700; margin: 0 0 4px; }
    .sub { margin: 0 0 20px; color: var(--muted); font-size: .95rem; }
    form { display: grid; gap: 14px; }
    label { font-size: .9rem; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="text"], input[type="password"] {
      width: 100%; padding: 12px 14px; border-radius: 12px;
      border: 1px solid var(--line); background: #fff; color: var(--text);
    }
    input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent), transparent 85%); }
    .btn {
      width: 100%; padding: 12px 16px; border-radius: 12px; border: none;
      background: linear-gradient(180deg, var(--accent), var(--accent-2)); color: white; font-weight: 700; cursor: pointer;
    }
    .only { margin-top: 10px; font-size: .85rem; color: var(--muted); text-align: center; }
    .legal { margin-top: 16px; font-size: .75rem; text-align: center; }
    .success { color: var(--success); }
    .error { color: var(--error); }
    .token { 
      background: #e8f5e9; 
      border: 1px solid #c8e6c9; 
      border-radius: 6px; 
      padding: 8px; 
      margin: 10px 0;
      font-family: monospace;
      font-size: 1.1rem;
      text-align: center;
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="logo" style="text-align:center; margin-bottom:20px;">
      <h1>Robot RRR</h1>
      <span style="color:var(--muted); font-size:.9rem;">Panel de Control</span>
    </div>

    <h1 class="title">Iniciar sesión</h1>
    <p class="sub">Accedé con tu usuario, contraseña e IP del servidor.</p>

    <form id="loginForm">
      <label for="serverIp">IP del servidor</label>
      <input id="serverIp" type="text" placeholder="192.168.x.x" required value="localhost">

      <label for="nick">Usuario</label>
      <input id="nick" type="text" placeholder="ADMIN, USER o VIEWER" required minlength="3" value="ADMIN">

      <label for="password">Contraseña</label>
      <input id="password" type="password" placeholder="••••••••" required minlength="1" value="ADMIN">

      <button class="btn" type="submit">Entrar</button>
      
      
      <div id="tokenDisplay" style="display: none;">
        <div class="token">Token: <span id="tokenValue"></span></div>
      </div>
      
      <p id="msg" class="legal" role="status" aria-live="polite"></p>
    </form>
  </main>

  <script>
  async function rpcCall(serverIp, method, paramsXml="") {
    const xml = `<?xml version="1.0"?>
<methodCall>
  <methodName>${method}</methodName>
  <params>${paramsXml}</params>
</methodCall>`;

    try {
      const res = await fetch(`http://${serverIp}:8080`, {
        method: "POST",
        headers: { "Content-Type": "text/xml" },
        body: xml
      });
      return await res.text();
    } catch (error) {
      throw new Error(`Error de conexión: ${error.message}`);
    }
  }

  // Función para parsear la respuesta XML
  function parseXmlResponse(xmlText) {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
    
    // Verificar si es una respuesta de error (fault)
    const fault = xmlDoc.getElementsByTagName("fault")[0];
    if (fault) {
      const faultString = xmlDoc.getElementsByTagName("string")[1]; // El segundo string contiene el mensaje
      return { success: false, error: faultString ? faultString.textContent : "Error desconocido" };
    }
    
    // Parsear respuesta exitosa
    const members = xmlDoc.getElementsByTagName("member");
    const result = { success: true };
    
    for (let member of members) {
      const name = member.getElementsByTagName("name")[0]?.textContent;
      const value = member.getElementsByTagName("string")[0]?.textContent;
      if (name && value) {
        result[name] = value;
      }
    }
    
    return result;
  }

  document.getElementById("loginForm").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const ip = document.getElementById("serverIp").value.trim();
    const nick = document.getElementById("nick").value.trim();
    const pass = document.getElementById("password").value.trim();
    const msg = document.getElementById("msg");
    const tokenDisplay = document.getElementById("tokenDisplay");
    
    msg.textContent = "Conectando con el servidor...";
    msg.className = "legal";
    tokenDisplay.style.display = "none";

    try {
      const xmlParams = `<param><value><string>${nick}</string></value></param>
                         <param><value><string>${pass}</string></value></param>`;
      
      const respuestaXml = await rpcCall(ip, "login", xmlParams);
      const resultado = parseXmlResponse(respuestaXml);
      
      if (resultado.success) {
        msg.textContent = `✅ ${resultado.message || 'Login exitoso!'}`;
        msg.className = "legal success";
        
        // Mostrar token
        if (resultado.token) {
          document.getElementById("tokenValue").textContent = resultado.token;
          tokenDisplay.style.display = "block";
        }
        
        // Guardar en sessionStorage
        sessionStorage.setItem("server_ip", ip);
        sessionStorage.setItem("auth_token", resultado.token || "0000");
        sessionStorage.setItem("user_privilege", resultado.privilege || "viewer");
        sessionStorage.setItem("username", nick);
        
        // Redirigir según privilegio después de 2 segundos
        setTimeout(() => {
          if (resultado.privilege === "admin") {
            window.location.href = "server_panel.html";
          } else {
            window.location.href = "user_panel.html";
          }
        }, 2000);
        
      } else {
        msg.textContent = `❌ ${resultado.error}`;
        msg.className = "legal error";
      }
      
    } catch(err) {
      console.error("Error:", err);
      msg.textContent = `❌ ${err.message}`;
      msg.className = "legal error";
    }
  });

  // Cargar valores por defecto para testing
  window.addEventListener('load', () => {
    console.log("Usuarios demo disponibles:");
    console.log("- ADMIN / ADMIN (admin)");
    console.log("- USER / USER (user)"); 
    console.log("- VIEWER / VIEWER (viewer)");
  });
  </script>
</body>
</html>